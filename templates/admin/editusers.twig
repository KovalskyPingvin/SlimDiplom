{% extends 'layouts/base.twig' %}

{% block title %}Управление учетными записями{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/css/admin/editusersstyle.css">
{% endblock %}

{% block content %}
<div class="editusers-page">  <!-- ← Обёртка -->
    <div class="content-wrapper">
        <h1 class="page-title">Управление учетными записями</h1>

        <div class="button-wrapper">
            <button onclick="openModal('addModal')">Добавить пользователя</button>
            <button onclick="openModal('exportModal')">Экспорт</button>
        </div>

        <div class="table-wrapper">
            <table class="user-table">
                <thead>
                    <tr>
                        <th>Логин</th>
                        <th>Пароль</th>
                        <th>Имя пользователя</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.log|e }}</td>
                            <td>{{ user.pass|e }}</td>
                            <td>{{ user.username|e }}</td>
                            <td>
                                <button class="edit-btn" onclick="openEditModal({{ user.id_user }}, '{{ user.log|e }}', '{{ user.pass|e }}', '{{ user.username|e }}')">Редактировать</button>
                                {% if user.id_user > 2 %}
                                    <button class="delete-btn danger" onclick="openDeleteModal({{ user.id_user }})">Удалить</button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h2>Добавить пользователя</h2>
            {% if errorAdd %}
                <div class="error-message">{{ errorAdd }}</div>
            {% endif %}
            <form method="post">
                <input type="hidden" name="action" value="add">
                <label>Логин:</label>
                <input type="text" name="log" required>
                <label>Пароль:</label>
                <input type="text" name="pass" required>
                <label>Имя пользователя:</label>
                <input type="text" name="username" required>
                <div class="modal-buttons">
                    <button type="submit" class="confirm">Добавить</button>
                    <button type="button" class="cancel" onclick="closeAllModals()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h2>Редактировать пользователя</h2>
            {% if errorEdit %}
                <div class="error-message">{{ errorEdit }}</div>
            {% endif %}
            <form method="post">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="id_user" id="edit_id_user">
                <label>Логин:</label>
                <input type="text" name="log" id="edit_log" required>
                <label>Пароль:</label>
                <input type="text" name="pass" id="edit_pass" required>
                <label>Имя пользователя:</label>
                <input type="text" name="username" id="edit_username" required>
                <div class="modal-buttons">
                    <button type="submit" class="confirm">Сохранить</button>
                    <button type="button" class="cancel" onclick="closeAllModals()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h2>Удалить пользователя?</h2>
            <form method="post">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="id_user" id="delete_id_user">
                <div class="modal-buttons">
                    <button type="submit" class="danger">Удалить</button>
                    <button type="button" class="cancel" onclick="closeAllModals()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="exportModal">
        <div class="modal">
            <h2>Экспортировать данные</h2>
            <form method="post" action="/admin/editusers/export" target="_blank">
                <label for="format">Выберите формат:</label>
                <select name="format" id="format" required>
                    <option value="xlsx">Excel (.xlsx)</option>
                    <option value="doc">Word (.doc)</option>
                </select>
                <div class="modal-buttons">
                    <button type="submit" class="confirm">Экспортировать</button>
                    <button type="button" class="cancel" onclick="closeAllModals()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function openModal(id) {
        closeAllModals();
        const modal = document.getElementById(id);
        if (modal) modal.classList.add('active');
    }

    function closeAllModals() {
        document.querySelectorAll('.modal-overlay').forEach(modal => modal.classList.remove('active'));
    }

    function openEditModal(id, log, pass, username) {
        document.getElementById('edit_id_user').value = id;
        document.getElementById('edit_log').value = log;
        document.getElementById('edit_pass').value = pass;
        document.getElementById('edit_username').value = username;
        openModal('editModal');
    }

    function openDeleteModal(id) {
        document.getElementById('delete_id_user').value = id;
        openModal('deleteModal');
    }
    </script>

    {% include 'components/notification.twig' %}
</div>  <!-- ← Закрывающий div для .editusers-page -->
{% endblock %}