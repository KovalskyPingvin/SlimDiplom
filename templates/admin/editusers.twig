{% extends 'layouts/base.twig' %}

{% block title %}Управление учетными записями{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/css/admin/editusersstyle.css">  <!-- ✅ ПРАВИЛЬНОЕ ИМЯ ФАЙЛА -->
{% endblock %}

{% block content %}
<div class="editusers-page">
    <div class="content-wrapper">
        <h1 class="h1-editusers">Управление учетными записями</h1>

        <!-- Форма добавления -->
        <div class="form-add-user">
            <h2>Добавить нового пользователя</h2>
            <form method="post" class="form-user">
                <input type="hidden" name="action" value="add">
                <label>Логин:
                    <input type="text" name="log" required>
                </label>
                <label>Пароль:
                    <input type="text" name="pass" required>
                </label>
                <label>Имя пользователя:
                    <input type="text" name="username" required>
                </label>
                <label>Роль:
                    <select name="role" required>
                        <option value="user">Пользователь</option>
                        <option value="admin_ui">Начальник УИиЦР</option>
                        <option value="admin_sksis">Администратор отдела СКСиС</option>
                        <option value="admin_uvl">Администратор отдела УВЛ</option>
                        <option value="admin_st">Администратор отдела СТ</option>
                        <option value="admin_it">Администратор отдела ИТ</option>
                    </select>
                </label>
                <button type="submit" class="btn-add-user">Добавить</button>
            </form>
        </div>

        <!-- Таблица пользователей -->
        {% if users|length > 0 %}
            <table class="table-users">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Логин</th>
                        <th>Имя пользователя</th>
                        <th>Роль</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                        <tr>
                            <td>{{ user.id_user }}</td>
                            <td>{{ user.log|e }}</td>
                            <td>{{ user.username|e }}</td>
                            <td>
                                {% set roleName = {
                                    'admin_ui': 'Начальник УИиЦР',
                                    'admin_sksis': 'Администратор отдела СКСиС',
                                    'admin_uvl': 'Администратор отдела УВЛ',
                                    'admin_st': 'Администратор отдела СТ',
                                    'admin_it': 'Администратор отдела ИТ',
                                    'user': 'Пользователь'
                                }[user.role] %}
                                {{ roleName|default('Неизвестная роль') }}
                            </td>
                            <td>
                                <button class="btn-edit" data-id="{{ user.id_user }}">Изменить</button>
                                {% if user.role not in ['admin_ui', 'admin_it'] %}
                                    <form method="POST" style="display:inline;" onsubmit="return confirm('Удалить пользователя?')">
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="id" value="{{ user.id_user }}">
                                        <button type="submit" class="btn-delete">Удалить</button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>Нет пользователей.</p>
        {% endif %}
    </div>
</div>

<!-- Модальное окно редактирования -->
<div id="editModal" class="modal-overlay">
    <div class="modal-container">
        <span class="modal-close" onclick="closeEditModal()">&times;</span>
        <h2>Редактировать пользователя</h2>
        <form id="editForm" method="POST">
            <input type="hidden" name="action" value="edit">
            <input type="hidden" name="id" id="editUserId">
            <label>Логин:
                <input type="text" name="log" id="editLog" required>
            </label>
            <label>Пароль (оставьте пустым, чтобы не менять):
                <input type="text" name="pass" id="editPass">
            </label>
            <label>Имя пользователя:
                <input type="text" name="username" id="editUsername" required>
            </label>
            <label>Роль:
                <select name="role" id="editRole" required>
                    <option value="user">Пользователь</option>
                    <option value="admin_ui">Начальник УИиЦР</option>
                    <option value="admin_sksis">Администратор отдела СКСиС</option>
                    <option value="admin_uvl">Администратор отдела УВЛ</option>
                    <option value="admin_st">Администратор отдела СТ</option>
                    <option value="admin_it">Администратор отдела ИТ</option>
                </select>
            </label>
            <button type="submit" class="btn-save">Сохранить</button>
        </form>
    </div>
</div>

<script>
    function openEditModal(id, log, username, role) {
        document.getElementById('editUserId').value = id;
        document.getElementById('editLog').value = log;
        document.getElementById('editUsername').value = username;
        document.getElementById('editRole').value = role;
        document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
    }

    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const tr = this.closest('tr');
            const id = tr.cells[0].textContent;
            const log = tr.cells[1].textContent;
            const username = tr.cells[2].textContent;
            const role = this.parentNode.querySelector('input[name="role"]').value || this.dataset.role;

            // Получим роль из текста ячейки
            const roleText = tr.cells[3].textContent.trim();
            const roleMap = {
                'Начальник УИиЦР': 'admin_ui',
                'Администратор отдела СКСиС': 'admin_sksis',
                'Администратор отдела УВЛ': 'admin_uvl',
                'Администратор отдела СТ': 'admin_st',
                'Администратор отдела ИТ': 'admin_it',
                'Пользователь': 'user'
            };
            const roleValue = roleMap[roleText] || 'user';

            openEditModal(id, log, username, roleValue);
        });
    });

    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (!confirm('Вы действительно хотите удалить пользователя?')) {
                e.preventDefault();
            }
        });
    });
</script>

{% include 'components/notification.twig' %}
{% endblock %}