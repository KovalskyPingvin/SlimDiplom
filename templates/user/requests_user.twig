{% extends 'layouts/base.twig' %}

{% block title %}Мои заявки{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/css/user/requests_user.css">
{% endblock %}

{% block extra_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="/js/user/requests_user.js"></script>
{% endblock %}

{% block content %}
<div class="requests-user-page">
    <h1 class="h1-requests-user">Мои заявки</h1>

    <div class="request-filter">
        <label>
            <input type="checkbox" id="filter-incomplete">
            Показать только незавершенные
        </label>
    </div>

    {% if requests|length > 0 %}
        <div class="table-wrapper">
            <table class="table-requests-user">
                <thead>
                    <tr>
                        <th>Тип</th>
                        <th>Отдел</th>
                        <th>Начальник отдела</th>
                        <th>Телефон</th>
                        <th>Инв. номер</th>
                        <th>Устройство</th>
                        <th>Корпус</th>
                        <th>Кабинет</th>
                        <th>Причина</th>
                        <th>Дата</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                        <tr data-id="{{ req.id_request }}" data-type="{{ req.request_type }}">
                            <td>{{ req.request_type|e }}</td>
                            <td>{{ req.department_name|e }}</td>
                            <td>{{ req.head_full_name|e }}</td>
                            <td>{{ req.phone|e }}</td>
                            <td>{{ req.inventory_number|e }}</td>
                            <td>{{ req.device_name|e }}</td>
                            <td>{{ req.building_number|e }}</td>
                            <td>{{ req.room_number|e }}</td>
                            <td>{{ req.reason|e }}</td>
                            <td>{{ req.submission_date|date('d.m.Y H:i') }}</td>
                            <td class="status-cell {{ req.status == 'Завершен' ? 'status-done' : 'status-pending' }}">
                                {{ req.status }}
                            </td>
                            <td>
                                <button class="btn-print"
                                    data-department="{{ req.department_name|e }}"
                                    data-chief="{{ req.head_full_name|e }}"
                                    data-phone="{{ req.phone|e }}"
                                    data-device="{{ req.device_name|e }}"
                                    data-inventory="{{ req.inventory_number|e }}"
                                    data-building="{{ req.building_number|e }}"
                                    data-room="{{ req.room_number|e }}"
                                    data-reason="{{ req.reason|e }}"
                                    data-recipient="{{ recipient_name|e }}">
                                    Печать
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if total_pages > 1 %}
            <div class="pagination requests-pagination">
                {% for i in 1..total_pages %}
                    <a href="?page={{ i }}" class="{{ i == current_page ? 'active' : '' }}">{{ i }}</a>
                {% endfor %}
            </div>
        {% endif %}

    {% else %}
        <p class="p-requests-empty">У вас пока нет заявок.</p>
    {% endif %}
</div>

<script>
    // === Фильтр заявок ===
    document.getElementById('filter-incomplete').addEventListener('change', function() {
        const showOnlyIncomplete = this.checked;
        document.querySelectorAll('.table-requests-user tbody tr').forEach(row => {
            const statusCell = row.querySelector('.status-cell');
            if (!statusCell) return;

            const status = statusCell.textContent.trim();
            if (showOnlyIncomplete) {
                if (status === "Завершен") {
                    row.style.display = "none";
                }
            } else {
                row.style.display = "";
            }
        });
    });
</script>

{% include 'components/notification.twig' %}
{% endblock %}